<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flex2048</title>

    <link rel="stylesheet" href="../styles/reset.css">
    <link rel="stylesheet" href="../styles/components/header.css">
    <link rel="stylesheet" href="../styles/components/desktop-block.css">
    <link rel="stylesheet" href="../styles/components/game/tile.css">
    <link rel="stylesheet" href="../styles/UI/my-button.css">
    <link rel="stylesheet" href="../styles/UI/my-select.css">
    <link rel="stylesheet" href="../styles/UI/my-checkbox.css">
    <link rel="stylesheet" href="../styles/UI/my-input.css">

    <link rel="stylesheet" href="../styles/pages/form-page.css">
</head>

<body>
    <div class="wrapper">
        <div class="header">
            <div class="my-container header__container">
                <a href="../index.html" class="header__logo-link">
                    <div class="header__logo-wrap-img">
                        <img src="../assets/images/logo.svg" alt="" class="logo-img">
                    </div>
                </a>
            </div>
        </div>

        <!-- ЗАГЛУШКА ДЛЯ ПК -->
        <div class="desktop-block">
            <div class="my-container desktop-block__container">
                <img src="./assets/images/logo.svg" alt="" class="desktop-block__logo">
                <div class="desktop-block__text">
                    Сайт доступен для мобильной версии <br> Откройте сайт на телефоне
                </div>
                <div class="desktop-block__icon-wrap">
                    <img src="../assets/images/desktop-icon.svg" alt="" class="desktop-block__icon">
                </div>
            </div>
        </div>

        <div class="main">
            <div class="form-page">
                <div class="my-container form-page__container">
                    <div class="form-page__texts">
                        <div class="form-page__title">Отлично, осталось только авторизоваться</div>
                        <div class="form-page__pre-title">Чтобы мы знали, кому отправить подарки.</div>
                    </div>
                    <form action="" class="form-page__form">
                        <input type="text" name="name-input" id="userName" class="my-input" placeholder="Имя">
                        <input type="tel" name="phone-input" id="userPhone" class="my-input" placeholder="Телефон">
                        <input type="tel" name="email-input" id="userEmail" class="my-input" placeholder="Email">
                        <div class="my-select-wrapper">
                            <select name="userCity" id="userCity" class="my-select__element">
                                <option class="my-select__option" value="Иркутск" default data-price="3990">Иркутск
                                </option>
                                <option class="my-select__option" value="Ангарск" data-price="3099">Ангарск</option>
                                <option class="my-select__option" value="Красноярск. Весны" data-price="3990">Красноярск.
                                    Весны</option>
                                <option class="my-select__option" value="Красноярск. Урицкого" data-price="3990">
                                    Красноярск. Урицкого
                                </option>
                                <option class="my-select__option" value="Новосибирск. Зыряновская" data-price="3990">
                                    Новосибирск. Зыряновская</option>
                                <option class="my-select__option" value="Новосибирск. Дуси" data-price="3799">Новосибирск. Дуси</option>
                                <option class="my-select__option" value="Тюмень" data-price="4499">Тюмень</option>
                                <option class="my-select__option" value="Саратов" data-price="3990">Саратов</option>
                                <option class="my-select__option" value="Екатеринбург" data-price="3990">Екатеринбург
                                </option>
                                <option class="my-select__option" value="Уфа" data-price="3990">Уфа</option>
                                <option class="my-select__option" value="Челябинск" data-price="3990">Челябинск
                                </option>
                                <option class="my-select__option" value="Казань" data-price="4499">Казань</option>
                            </select>
                            <div class="my-select-arrow"></div>
                        </div>
                        <label for="haveMembership" class="my-checkbox">
                            <input type="checkbox" name="haveMembership" id="haveMembership" class="my-checkbox__old">
                            <span class="my-checkbox__new"></span>
                            <span class="my-checkbox__text">У меня есть абонемент THE FLEX</span>
                        </label>
                        <label for="agreement" class="my-checkbox">
                            <input type="checkbox" name="agreement" id="agreement" class="my-checkbox__old">
                            <span class="my-checkbox__new"></span>
                            <span class="my-checkbox__text">Я согласен(а) <a href="my-checkbox__text-link" class="my-checkbox__text-link">с политикой конфиденциальности</a></span>
                        </label>
                    </form>
                    <a href="" class="my-button">далее</a>
                </div>
            </div>
        </div>
    </div>

    <script src="../assets/scripts/phone-mask.js"></script>

    <script>
        const form = document.querySelector('.form-page__form');
        const nameInput = document.querySelector('#userName');
        const emailInput = document.querySelector('#userEmail');
        const agreementCheckbox = document.querySelector('#agreement');

        nameInput.addEventListener('input', function () {
            validateName();
        });

        emailInput.addEventListener('input', function () {
            validateEmail();
        });

        agreementCheckbox.addEventListener('change', function () {
    validateAgreement();
});

        function validateName() {
            const value = nameInput.value.trim();

            const regex = /^[A-Za-zА-Яа-яЁё\s]+$/;

            if ((!value) || (!regex.test(value))) {
                nameInput.classList.add('error');
                nameInput.placeholder = 'Введите правильно';
                return false;
            } else {
                nameInput.classList.remove('error');
                nameInput.placeholder = 'Имя';
                return true;
            }
        }

        function validateEmail() {
        const value = emailInput.value.trim();
        const regex = /^[a-zA-Z0-9._-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,4}$/;

        if ((!value) || (!regex.test(value))) {
            emailInput.classList.add('error');
            emailInput.placeholder = 'Введите правильно';
            return false;
        } else {
            emailInput.classList.remove('error');
            emailInput.placeholder = 'Email';
            return true;
        }
    }

    function validateAgreement() {
    const agreementLabel = agreementCheckbox.closest('label');
    if (!agreementCheckbox.checked) {
        agreementLabel.classList.add('error');
        return false;
    } else {
        agreementLabel.classList.remove('error');
        return true;
    }
}

        document.querySelector('.my-button').addEventListener('click', function (event) {
            event.preventDefault();

            const isNameValid = validateName();
    const isEmailValid = validateEmail();
    const isAgreementValid = validateAgreement();

    if (!isNameValid || !isEmailValid || !isAgreementValid) {
        return;
    }

            const userData = {
                id: null,
                name: form.querySelector('#userName').value,
                phone: form.querySelector('#userPhone').value,
                email: form.querySelector('#userEmail').value,
                city: form.querySelector('#userCity').value,
                hasMembership: form.querySelector('#haveMembership').checked,
                score: null,
            };

            const selectedSity = {
                city: userData.city,
                price: +form.querySelector('#userCity').options[form.querySelector('#userCity').selectedIndex].getAttribute("data-price"),
            }

            sessionStorage.setItem("userData", JSON.stringify(userData));
            sessionStorage.setItem("selectedCity", JSON.stringify(selectedSity));

            fetch("https://flex.gromkov.ru/api/database/rows/table/602/?user_field_names=true", {
                method: "POST",
                headers: {
                    Authorization: "Token EsY3jhdUa4FMCo4GyW0alRmpFSZqjCed",
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    Name: userData.name,
                    Phone: userData.phone,
                    Email: userData.email,
                    Card: userData.hasMembership,
                    City: userData.city,
                })
            })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(errorData => {
                            throw new Error(`Ошибка: ${response.status} ${response.statusText}. ${JSON.stringify(errorData)}`);
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    console.log("Данные успешно отправлены:", data);
                    const id = data.id;
                    userData.id = id;

                    sessionStorage.setItem("userData", JSON.stringify(userData));
                    console.log(JSON.parse(sessionStorage.getItem("userData")));

                    window.location.href = './game-page.html';
                })
                .catch(error => {
                    console.error('Ошибка при отправке данных:', error);
                    alert('Произошла ошибка при отправке данных. Пожалуйста, попробуйте еще раз.');
                });
        });
    </script>
</body>

</html>