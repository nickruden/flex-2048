<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flex2048</title>

    <link rel="stylesheet" href="../styles/reset.css">
    <link rel="stylesheet" href="../styles/components/header.css">
    <link rel="stylesheet" href="../styles/components/desktop-block.css">
    <link rel="stylesheet" href="../styles/components/game/tile.css">
    <link rel="stylesheet" href="../styles/UI/my-button.css">
    <link rel="stylesheet" href="../styles/UI/my-select.css">
    <link rel="stylesheet" href="../styles/UI/my-checkbox.css">
    <link rel="stylesheet" href="../styles/UI/my-input.css">

    <link rel="stylesheet" href="../styles/pages/form-page.css">
</head>

<body>
    <div class="wrapper">
        <div class="header">
            <div class="my-container header__container">
                <a href="../index.html" class="header__logo-link">
                    <div class="header__logo-wrap-img">
                        <img src="../assets/images/logo.svg" alt="" class="logo-img">
                    </div>
                </a>
            </div>
        </div>

        <!-- ЗАГЛУШКА ДЛЯ ПК -->
        <div class="desktop-block">
            <div class="my-container desktop-block__container">
                <img src="./assets/images/logo.svg" alt="" class="desktop-block__logo">
                <div class="desktop-block__text">
                    Сайт доступен для мобильной версии <br> Откройте сайт на телефоне
                </div>
                <div class="desktop-block__icon-wrap">
                    <img src="../assets/images/desktop-icon.svg" alt="" class="desktop-block__icon">
                </div>
            </div>
        </div>

        <div class="main">
            <div class="form-page">
                <div class="my-container form-page__container">
                    <div class="form-page__texts">
                        <div class="form-page__title">Отлично, осталось только авторизоваться</div>
                        <div class="form-page__pre-title">Чтобы мы знали, кому отправить подарки.</div>
                    </div>
                    <form action="" class="form-page__form">
                        <input type="text" name="name-input" id="userName" class="my-input" placeholder="Имя">
                        <input type="tel" name="phone-input" id="userPhone" class="my-input" placeholder="Телефон">
                        <div class="my-select-wrapper">
                            <select name="userCity" id="userCity" class="my-select__element">
                                <option class="my-select__option" value="irkutsk" default data-price="5000">Иркутск
                                </option>
                                <option class="my-select__option" value="angarsk" data-price="3000">Ангарск</option>
                                <option class="my-select__option" value="krasnoyarskVesni" data-price="5000">Красноярск.
                                    Весны</option>
                                <option class="my-select__option" value="krasnoyarskUritskogo" data-price="5000">
                                    Красноярск. Урицкого
                                </option>
                                <option class="my-select__option" value="novosibirskZyryanovskaya" data-price="5000">
                                    Новосибирск.
                                    Зыряновская</option>
                                <option class="my-select__option" value="novosibirskDusi" data-price="5000">Новосибирск.
                                    Дуси</option>
                                <option class="my-select__option" value="tyumen" data-price="5000">Тюмень</option>
                                <option class="my-select__option" value="saratov" data-price="5000">Саратов</option>
                                <option class="my-select__option" value="ekaterinburg" data-price="5000">Екатеринбург
                                </option>
                                <option class="my-select__option" value="ufa" data-price="5000">Уфа</option>
                                <option class="my-select__option" value="chelyabinsk" data-price="5000">Челябинск
                                </option>
                                <option class="my-select__option" value="kazan" data-price="5000">Казань</option>
                            </select>
                            <div class="my-select-arrow"></div>
                        </div>
                        <label for="haveMembership" class="my-checkbox">
                            <input type="checkbox" name="haveMembership" id="haveMembership" class="my-checkbox__old">
                            <span class="my-checkbox__new"></span>
                            <span class="my-checkbox__text">У меня есть абонемент THE FLEX</span>
                        </label>
                    </form>
                    <a href="" class="my-button">далее</a>
                </div>
            </div>
        </div>
    </div>

    <script src="../assets/scripts/phone-mask.js"></script>

    <script>
        const form = document.querySelector('.form-page__form');
        const nameInput = document.querySelector('#userName');

        nameInput.addEventListener('input', function () {
            validateName();
        });

        function validateName() {
            const value = nameInput.value.trim();

            const regex = /^[A-Za-zА-Яа-яЁё\s]+$/;

            if ((!value) || (!regex.test(value))) {
                nameInput.classList.add('error');
                nameInput.placeholder = 'Введите правильно';
                return false;
            } else {
                nameInput.classList.remove('error');
                nameInput.placeholder = 'Имя';
                return true;
            }
        }

        document.querySelector('.my-button').addEventListener('click', function (event) {
            event.preventDefault();

            if (!validateName()) {
                return;
            }

            const userData = {
                id: null,
                name: form.querySelector('#userName').value,
                phone: form.querySelector('#userPhone').value,
                city: form.querySelector('#userCity').value,
                hasMembership: form.querySelector('#haveMembership').checked,
                score: null,
            };

            const selectedSity = {
                city: userData.city,
                price: +form.querySelector('#userCity').options[form.querySelector('#userCity').selectedIndex].getAttribute("data-price"),
            }

            sessionStorage.setItem("userData", JSON.stringify(userData));
            sessionStorage.setItem("selectedCity", JSON.stringify(selectedSity));

            fetch("https://flex.gromkov.ru/api/database/rows/table/602/?user_field_names=true", {
                method: "POST",
                headers: {
                    Authorization: "Token EsY3jhdUa4FMCo4GyW0alRmpFSZqjCed",
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    Name: userData.name,
                    Phone: userData.phone,
                    Card: userData.hasMembership,
                    City: userData.city,
                })
            })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(errorData => {
                            throw new Error(`Ошибка: ${response.status} ${response.statusText}. ${JSON.stringify(errorData)}`);
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    console.log("Данные успешно отправлены:", data);
                    const id = data.id;
                    userData.id = id;

                    sessionStorage.setItem("userData", JSON.stringify(userData));
                    console.log(JSON.parse(sessionStorage.getItem("userData")));

                    window.location.href = './game-page.html';
                })
                .catch(error => {
                    console.error('Ошибка при отправке данных:', error);
                    alert('Произошла ошибка при отправке данных. Пожалуйста, попробуйте еще раз.');
                });
        });
    </script>
</body>

</html>